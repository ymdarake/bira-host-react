# ToDoリスト：アプリケーションロジックの改善点

## 1. 詳細ページ (`Detail.tsx`) の削除ロジックの堅牢化
### 現状と問題点
現在、PDFの削除ロジックはFirestoreのデータ削除を先に行い、その後にCloud Storageのファイル削除を行います。この順序だと、Storageのファイル削除が失敗した場合に、管理画面からは消えているがCloud Storageに孤立したゴミファイルが残るリスクがあります。このファイルは、Firestore上の参照が消えているため、後から削除することが困難になります。

### 改善提案
データの一貫性とリトライ可能性を高めるため、削除処理の順序とエラーハンドリングを見直すべきです。
1.  **Cloud Storageのファイル削除を先に行う。**
2.  **Storageの削除が失敗した場合、その旨をユーザーに伝え、Firestoreのデータ削除は行わない。** これにより、ユーザーは問題を把握し、リトライすることができます。
3.  Storageの削除時に「ファイルが見つからない」エラー (`storage/object-not-found`) の場合は、既にファイルが存在しないと判断し、Firestoreのデータ削除に進みます。

## 2. ホームページ (`Home.tsx`) のPDFリスト表示パフォーマンス
### 現状と問題点
現在、トップページでは取得したすべてのPDFデータに対して `PDFViewer` コンポーネントを直接レンダリングしています。PDFのレンダリングはリソースを多く消費する処理であり、表示するPDFの数が増えるにつれてページの読み込み速度やスクロールパフォーマンスが著しく低下する可能性があります。

### 改善提案
ユーザー体験を向上させるため、PDFリストの表示を軽量化すべきです。
*   各PDFに対して、Cloud Storageに保存された**サムネイル画像**（最初のページなど）を表示することを検討します。
*   ユーザーが個々のリストアイテムをクリックした場合にのみ、フル機能の `PDFViewer` を表示するように変更します。

## 3. Firebase設定の環境変数化
### 現状と問題点
FirebaseのAPIキーやプロジェクトIDなどの設定情報が `src/lib/firebase.ts` 内にハードコードされています。これにより、開発環境と本番環境で異なる設定を使用したい場合や、秘匿性の高い情報（APIキー自体は公開されても問題ないが、設定変更の手間）を変更したい場合に、直接コードを修正する必要があります。

### 改善提案
プロジェクトの運用性を高めるため、Firebaseの設定を環境変数で管理すべきです。
*   `.env` ファイルを作成し、そこにFirebaseの各種設定値を記述します。
*   `src/lib/firebase.ts` では、`import.meta.env` を通じてこれらの環境変数を読み込むように変更します。
*   `.gitignore` に `.env` を追加し、環境設定が誤ってリポジトリにコミットされないようにします。

## 4. Firebaseセキュリティルールにおける管理者UIDの動的化とデータ構造の最適化
### 現状と問題点
現在、`firestore.rules` と `storage.rules` で管理者UIDのチェックを動的化（ハードコード排除）しようとしていますが、以下の課題があります。
1.  **Storage Rulesの制約**: `storage.rules` からはFirestoreへのアクセス（`exists` や `get`）ができないため、Firestore上の `admin` コレクションを参照して権限を判定することができません。
2.  **Firestoreデータ構造**: `firestore.rules` で `exists()` を使って効率的に管理者チェックを行うには、`admin` コレクションの「ドキュメントID」自体がユーザーのUIDと一致している必要があります（現在は自動生成ID）。

### 改善提案
セキュリティと運用性を向上させるため、以下の段階的な対応を検討します。

#### フェーズ1: Firestoreデータ構造の修正とFirestoreルールの最適化
*   Firestore上の `admin` コレクションのデータを移行し、各ドキュメントのIDを対応する管理者のUser UIDに変更します。
*   `firestore.rules` では `exists(/databases/$(database)/documents/admin/$(request.auth.uid))` を使用して、自身の管理者権限を効率的にチェックするようにします。
*   フロントエンドの `isAdmin` 実装も、`query` ではなく `getDoc` を使用して直接ID指定で取得するように変更し、パフォーマンスを向上させます。

#### フェーズ2: Storage Rulesの動的化 (Custom Claimsの導入)
*   Storage RulesではFirestoreを参照できないため、Firebase Authenticationの **Custom Claims** を利用します。
*   Cloud Functions等を導入し、`admin` コレクションへの追加・削除をトリガーにして、対象ユーザーのAuthトークンに `admin: true` などのカスタムクレームを付与・削除する仕組みを構築します。
*   `storage.rules` (および `firestore.rules`) では `request.auth.token.admin == true` をチェックするだけで済むようになり、最も高速かつセキュアな判定が可能になります。
